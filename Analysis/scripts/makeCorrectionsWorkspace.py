#!/usr/bin/env python
import ROOT
# import json
import argparse
from array import array
from Acorn.Analysis.workspaceTools import *


def GetFromTFile(str):
    f = ROOT.TFile(str.split(':')[0])
    obj = f.Get(str.split(':')[1]).Clone()
    f.Close()
    return obj

# Boilerplate
ROOT.PyConfig.IgnoreCommandLineOptions = True
ROOT.gROOT.SetBatch(ROOT.kTRUE)
ROOT.RooWorkspace.imp = getattr(ROOT.RooWorkspace, 'import')
ROOT.TH1.AddDirectory(0)

parser = argparse.ArgumentParser()

parser.add_argument('--era', default='2016',
                    help='The dataset to target')
parser.add_argument('--debug', action='store_true',
                    help='Print debug output')
args = parser.parse_args()

# ROOT.gROOT.LoadMacro("CrystalBallEfficiency.cxx+")

w = ROOT.RooWorkspace('w')

era = args.era


###############################################################################
## Pileup
###############################################################################

if era == '2016':
    mc_edges = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17,
                18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33,
                34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49,
                50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65,
                66, 67, 68, 69, 70, 71, 72, 73, 74]
    mc_probs = [1.78653e-05, 2.56602e-05, 5.27857e-05, 8.88954e-05, 0.000109362,
                0.000140973, 0.000240998, 0.00071209, 0.00130121, 0.00245255,
                0.00502589, 0.00919534, 0.0146697, 0.0204126, 0.0267586, 0.0337697,
                0.0401478, 0.0450159, 0.0490577, 0.0524855, 0.0548159, 0.0559937,
                0.0554468, 0.0537687, 0.0512055, 0.0476713, 0.0435312, 0.0393107,
                0.0349812, 0.0307413, 0.0272425, 0.0237115, 0.0208329, 0.0182459,
                0.0160712, 0.0142498, 0.012804, 0.011571, 0.010547, 0.00959489,
                0.00891718, 0.00829292, 0.0076195, 0.0069806, 0.0062025, 0.00546581,
                0.00484127, 0.00407168, 0.00337681, 0.00269893, 0.00212473, 0.00160208,
                0.00117884, 0.000859662, 0.000569085, 0.000365431, 0.000243565,
                0.00015688, 9.88128e-05, 6.53783e-05, 3.73924e-05, 2.61382e-05,
                2.0307e-05, 1.73032e-05, 1.435e-05, 1.36486e-05, 1.35555e-05,
                1.37491e-05, 1.34255e-05, 1.33987e-05, 1.34061e-05, 1.34211e-05,
                1.34177e-05, 1.32959e-05, 1.33287e-05]
    h_data = GetFromTFile('input/pileup_wgamma_2016_v1.root:pileup')

if era == '2017':
    mc_edges = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18,
                19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34,
                35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
                51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66,
                67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82,
                83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99]
    mc_probs = [3.39597497605e-05, 6.63688402133e-06, 1.39533611284e-05, 3.64963078209e-05,
                6.00872171664e-05, 9.33932578027e-05, 0.000120591524486, 0.000128694546198,
                0.000361697233219, 0.000361796847553, 0.000702474896113, 0.00133766053707,
                0.00237817050805, 0.00389825605651, 0.00594546732588, 0.00856825906255,
                0.0116627396044, 0.0148793350787, 0.0179897368379, 0.0208723871946,
                0.0232564170641, 0.0249826433945, 0.0262245860346, 0.0272704617569,
                0.0283301107549, 0.0294006137386, 0.0303026836965, 0.0309692426278,
                0.0308818046328, 0.0310566806228, 0.0309692426278, 0.0310566806228,
                0.0310566806228, 0.0310566806228, 0.0307696426944, 0.0300103336052,
                0.0288355370103, 0.0273233309106, 0.0264343533951, 0.0255453758796,
                0.0235877272306, 0.0215627588047, 0.0195825559393, 0.0177296309658,
                0.0160560731931, 0.0146022004183, 0.0134080690078, 0.0129586991411,
                0.0125093292745, 0.0124360740539, 0.0123547104433, 0.0123953922486,
                0.0124360740539, 0.0124360740539, 0.0123547104433, 0.0124360740539,
                0.0123387597772, 0.0122414455005, 0.011705203844, 0.0108187105305,
                0.00963985508986, 0.00827210065136, 0.00683770076341, 0.00545237697118,
                0.00420456901556, 0.00367513566191, 0.00314570230825, 0.0022917978982,
                0.00163221454973, 0.00114065309494, 0.000784838366118, 0.000533204105387,
                0.000358474034915, 0.000238881117601, 0.0001984254989, 0.000157969880198,
                0.00010375646169, 6.77366175538e-05, 4.39850477645e-05, 2.84298066026e-05,
                1.83041729561e-05, 1.17473542058e-05, 7.51982735129e-06, 6.16160108867e-06,
                4.80337482605e-06, 3.06235473369e-06, 1.94863396999e-06, 1.23726800704e-06,
                7.83538083774e-07, 4.94602064224e-07, 3.10989480331e-07, 1.94628487765e-07,
                1.57888581037e-07, 1.2114867431e-07, 7.49518929908e-08, 4.6060444984e-08,
                2.81008884326e-08, 1.70121486128e-08, 1.02159894812e-08]
    h_data = GetFromTFile('input/pileup_wgamma_2017_v1.root:pileup')

if era == '2018':
    mc_edges = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14,
                15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26,
                27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38,
                39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
                51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62,
                63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74,
                75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86,
                87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98]
    mc_probs = [0.00056178559316322207, 0.0007578881923109293, 0.00089840730652213097, 0.0010038191685453057, 0.0011915955692529678,
                0.0016831225948408246, 0.0027497191913425922, 0.0045576253905892372, 0.0069810771383345127, 0.0095816180109977722,
                0.011853505857288837, 0.013561941683292389, 0.014868909493088722, 0.016164621338248253, 0.017800241708755493,
                0.019943427294492722, 0.022553266957402229, 0.02537936344742775, 0.027978429570794106, 0.029862202703952789,
                0.030737783759832382, 0.030647184699773788, 0.029888983815908432, 0.028840301558375359, 0.027826078236103058,
                0.027054192498326302, 0.026599425822496414, 0.02642328292131424, 0.026400813832879066, 0.026344424113631248,
                0.026030091568827629, 0.025283832103013992, 0.024102954193949699, 0.022694429382681847, 0.021359216421842575,
                0.020321305841207504, 0.019643651321530342, 0.019244605675339699, 0.018951877951622009, 0.018589355051517487,
                0.018086889758706093, 0.017514361068606377, 0.016997335478663445, 0.01660793274641037, 0.016348866745829582,
                0.016209937632083893, 0.016200525686144829, 0.016327474266290665, 0.016558451578021049, 0.016807874664664268,
                0.016936073079705238, 0.016756467521190643, 0.01605769619345665, 0.014654850587248802, 0.012486033141613007,
                0.0097413137555122375, 0.0068911332637071609, 0.0044789197854697704, 0.0028035130817443132, 0.0017981450073421001,
                0.0011986247263848782, 0.00078225688776001334, 0.00046188471606001258, 0.0002335387107450515, 9.8074830020777881e-05,
                3.36361990775913e-05, 9.325763130618725e-06, 2.0754421257151989e-06, 3.6864730645902455e-07, 5.1980304505150343e-08,
                5.7291127397718355e-09, 4.2278064382728076e-10, 0.0, 0.0, 0.0,
                0.0, 0.0, 0.0, 0.0, 0.0,
                0.0, 0.0, 0.0, 0.0, 0.0,
                0.0, 0.0, 0.0, 0.0, 0.0,
                0.0, 0.0, 0.0, 0.0, 0.0,
                0.0, 0.0, 0.0, 0.0]
    h_data = GetFromTFile('input/pileup_wgamma_2018_v1.root:pileup')

print len(mc_edges), len(mc_probs)

h_mc = ROOT.TH1D('mc_pileup', '', len(mc_edges), mc_edges[0], mc_edges[-1] + 1)
for i in range(len(mc_edges)):
    if i >= len(mc_probs):
        h_mc.SetBinContent(i + 1, 0.)
    else:
        h_mc.SetBinContent(i + 1, mc_probs[i])

# Fix for very large weights in 2018
if era == '2018':
    restrict = 65
    h_mc_new = ROOT.TH1D('mc_pileup', '', restrict, 0., float(restrict))
    h_data_new = ROOT.TH1D('data_pileup', '', restrict, 0., float(restrict))
    for i in range(restrict):
        h_mc_new.SetBinContent(i + 1, h_mc.GetBinContent(i + 1))
        h_data_new.SetBinContent(i + 1, h_data.GetBinContent(i + 1))
    h_mc = h_mc_new
    h_data = h_data_new

h_data.Scale(1. / h_data.Integral())
h_mc.Scale(1. / h_mc.Integral())

SafeWrapHist(w, ['pu_int'], h_data, name='pileup_data')
SafeWrapHist(w, ['pu_int'], h_mc, name='pileup_mc')

w.factory('expr::pileup_ratio("@0/@1", pileup_data, pileup_mc)')

if args.debug:
    print '>> Debug pileup weights:'
    x = 0.5
    for i in xrange(100):
        w.var('pu_int').setVal(x)
        print 'pu_int = %f, pileup_ratio = %f' % (x, w.function('pileup_ratio').getVal())
        x += 1.0

###############################################################################
## Muons
###############################################################################
loc = 'input/muons/%s' % era
if era == '2016':
    histsToWrap = [
        (loc + '/trigger/EfficienciesAndSF_RunBtoF.root:IsoMu24_OR_IsoTkMu24_PtEtaBins/pt_abseta_ratio', 'm_trg24_bf_ratio'),
        (loc + '/trigger/EfficienciesAndSF_Period4.root:IsoMu24_OR_IsoTkMu24_PtEtaBins/pt_abseta_ratio', 'm_trg24_gh_ratio'),
        (loc + '/id/EfficienciesAndSF_BCDEF.root:MC_NUM_MediumID2016_DEN_genTracks_PAR_pt_eta/pt_abseta_ratio', 'm_id_bf_ratio'),
        (loc + '/id/EfficienciesAndSF_GH.root:MC_NUM_MediumID_DEN_genTracks_PAR_pt_eta/pt_abseta_ratio', 'm_id_gh_ratio'),
        (loc + '/iso/EfficienciesAndSF_BCDEF.root:TightISO_MediumID_pt_eta/pt_abseta_ratio', 'm_iso_bf_ratio'),
        (loc + '/iso/EfficienciesAndSF_GH.root:TightISO_MediumID_pt_eta/pt_abseta_ratio', 'm_iso_gh_ratio')
    ]

    for task in histsToWrap:
        SafeWrapHist(w, ['m_pt', 'expr::m_abs_eta("TMath::Abs(@0)",m_eta[0])'],
                              GetFromTFile(task[0]), name=task[1])

    # Factor of 0.439 is the lumi of G+H
    for t in ['trg24', 'id', 'iso']:
        w.factory('expr::m_%s_ratio("@0*(1-0.439) + @1*0.439", m_%s_bf_ratio, m_%s_gh_ratio)' % (t, t, t))

    muon_trk_eff_hist = TGraphAsymmErrorsToTH1D(GetFromTFile(loc + '/track/Tracking_EfficienciesAndSF_BCDEFGH.root:ratio_eff_eta3_dr030e030_corr'))
    SafeWrapHist(w, ['m_eta'], muon_trk_eff_hist, name='m_trk_ratio')

    w.factory('expr::m_idisotrk_ratio("@0*@1*@2", m_id_ratio, m_iso_ratio, m_trk_ratio)')

###############################################################################
## Photons
###############################################################################
loc = 'input/photons/%s' % era

if era == '2016':
    histsToWrap = [
        (loc + '/egammaEffi.txt_EGM2D.root:EGamma_SF2D', 'p_id_ratio')
    ]

    for task in histsToWrap:
        SafeWrapHist(w, ['p_eta', 'p_pt'],
                              GetFromTFile(task[0]), name=task[1])

w.Print()
w.writeToFile('wgamma_corrections_%s_v1.root' % era)
w.Delete()

